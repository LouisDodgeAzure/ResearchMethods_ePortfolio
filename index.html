<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>E‑Portfolio – Unit Summaries</title>
  <meta name="description" content="Single‑page e‑portfolio template with auto‑discovered attachments and icons based on file extensions. Supports local dev and GitHub Pages." />
  <style>
    :root { --bg:#f8fafc; --surface:#ffffff; --text:#0f172a; --muted:#475569; --border:#e2e8f0; --accent:#2563eb; --chip:#eaf2ff; --focus:#94a3b8; --radius-xl:16px; --shadow-sm:0 2px 8px rgba(2,6,23,.05); --shadow-md:0 8px 24px rgba(2,6,23,.08); --maxw:1200px; }
    @media (prefers-color-scheme: dark){ :root{ --bg:#0b1220; --surface:#0f172a; --text:#e6edf7; --muted:#94a3b8; --border:#1f2a44; --accent:#60a5fa; --chip:#0b234a; --focus:#334155; --shadow-sm:0 2px 8px rgba(0,0,0,.3); --shadow-md:0 12px 28px rgba(0,0,0,.35);} }
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial;color:var(--text);background:radial-gradient(1200px 400px at 50% -10%, rgba(37,99,235,.08), transparent 60%),var(--bg);line-height:1.6;scroll-behavior:smooth}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .wrapper{max-width:var(--maxw);margin:0 auto;padding:24px clamp(16px,3vw,32px);display:grid;grid-template-columns:300px 1fr;gap:28px}
    header.site{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(6px);background:color-mix(in hsl, var(--bg), transparent 25%);border-bottom:1px solid var(--border)}
    .site-inner{max-width:var(--maxw);margin:0 auto;padding:14px clamp(16px,3vw,32px);display:flex;align-items:center;justify-content:space-between;gap:16px}
    .brand{display:grid;gap:2px} .brand b{font-size:1.05rem;letter-spacing:.2px} .brand small{color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:var(--surface);color:var(--text);padding:8px 12px;border-radius:999px;font-weight:600;font-size:.9rem;box-shadow:var(--shadow-sm);cursor:pointer}
    .btn:hover{border-color:color-mix(in hsl, var(--accent), var(--border) 60%)}
    nav#toc{position:sticky;top:68px;align-self:start;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow-sm);padding:14px}
    #toc h2{font-size:.95rem;margin:6px 8px 12px;color:var(--muted)}
    .toc-list{list-style:none;margin:0;padding:0;display:grid;gap:6px}
    .toc-list a{display:grid;grid-template-columns:28px 1fr;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid transparent}
    .toc-list a:hover{background:var(--chip);border-color:color-mix(in hsl, var(--accent), transparent 70%);text-decoration:none}
    .toc-unit{display:inline-grid;place-content:center;width:24px;height:24px;background:var(--accent);color:white;border-radius:6px;font:600 12px/1 ui-sans-serif,system-ui}
    main{display:grid;gap:16px}
    .intro{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow-md);padding:clamp(16px,2.5vw,28px)}
    .meta{display:flex;flex-wrap:wrap;gap:12px;color:var(--muted);font-size:.95rem}
    .chip{background:var(--chip);padding:4px 10px;border-radius:999px;border:1px solid color-mix(in hsl, var(--accent), transparent 70%)}
    .units{display:grid;gap:18px}
    section.unit{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-xl);box-shadow:var(--shadow-sm);padding:clamp(16px,2.5vw,28px);position:relative}
    .unit header{display:grid;gap:8px;margin-bottom:8px}
    .unit h2{margin:0;font-size:clamp(1.1rem,1.2rem + .4vw,1.6rem);line-height:1.25;letter-spacing:.2px}
    .unit h2 .hash{opacity:0;transition:opacity .2s ease;margin-left:8px;font-weight:700;color:var(--accent)}
    .unit:hover h2 .hash{opacity:1}
    .unit .summary{display:grid;row-gap:10px;border-left:3px solid color-mix(in hsl, var(--accent), transparent 70%);padding-left:12px}
    .unit .summary p{margin:0;display:grid;grid-template-columns:12ch 1fr;column-gap:12px;align-items:start}
    .unit .summary p .label{color:var(--muted);font-weight:600}
    .docs{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-top:12px}
    .doc{display:grid;gap:4px;padding:10px 12px;border:1px dashed color-mix(in hsl, var(--accent), var(--border) 75%);border-radius:12px}
    .doc a{font-weight:600} .doc small{color:var(--muted)}
    .refs{margin-top:8px;font-size:.95rem;color:var(--muted)} .refs li{margin-bottom:4px}
    .sr-only{position:absolute !important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    @media (max-width:960px){.wrapper{grid-template-columns:1fr} nav#toc{position:relative;top:0}}
    @media print{header.site,nav#toc{display:none !important} body{background:#fff} a{color:#000;text-decoration:none} a[href^="#"]::after{content:""} section.unit{box-shadow:none;break-inside:avoid;page-break-inside:avoid}}
  </style>
</head>
<body id="top">
  <a class="sr-only" href="#content">Skip to content</a>

  <header class="site" role="banner">
    <div class="site-inner">
      <div class="brand">
        <b>E‑Portfolio · Unit Summaries</b>
        <small><span aria-hidden>👤</span> <span id="brandMeta">Louis Dodge · Module: <em>Methods and Professional Practice July 2025 B.</em> · Academic Year: 2025</span></small>
      </div>
      <div class="actions">
        <a class="btn" href="#toc">Jump to Units</a>
        <a class="btn" href="#top" title="Back to top">Top</a>
      </div>
    </div>
  </header>

  <div class="wrapper">
    <nav id="toc" aria-label="Units navigation">
      <h2>Units</h2>
      <ol class="toc-list" id="tocList"></ol>
    </nav>

    <main id="content" role="main">
      <section class="intro" aria-labelledby="intro-title">
        <h1 id="intro-title" style="margin-top:0">Welcome</h1>
        <p>Welcome to my e‑portfolio for <strong>Methods and Professional Practice (July 2025 B)!</strong>.</p>
      </section>

      <div class="units" id="units"></div>
    </main>
  </div>

  <script>
    // ---------------- CONFIG ----------------
    const CONFIG = {
      mode: 'local', // 'local' | 'github' | 'auto'
      student: 'Louis Dodge',
      module: 'Methods and Professional Practice July 2025 B.',
      academicYear: '2025',
      github: {
        user: 'LouisDodgeAzure',
        repo: 'ePortfolio_Site',
        branch: 'main',      // or 'gh-pages'
        unitsDir: 'units'
      },
      local: {
        unitsDir: 'units',
        useManifest: true,
        manifest: 'units/index.json',
        probePattern: 'unit-${n}.json',
        startAt: 1,
        maxUnits: 30
      },
      docs: {
        mode: 'local', // 'github' | 'local' | 'auto'
        baseDirGithub: 'attachments/units',
        baseDirLocal: 'attachments/units',
        localManifest: 'attachments/index.json' // { "unit-1": ["file1.docx", ...], ... }
      }
    };

    // --------------- Helpers ---------------
    function resolveHref(href){ try{ return new URL(href, window.location.origin + window.location.pathname).href; }catch{ return href; } }
    function fileIconByExt(filename){
      const ext = (filename.split('.').pop()||'').toLowerCase();
      if(['pdf'].includes(ext)) return '📄';
      if(['doc','docx','rtf','odt'].includes(ext)) return '📝';
      if(['xls','xlsx','csv','ods'].includes(ext)) return '📊';
      if(['ppt','pptx','key'].includes(ext)) return '📽️';
      if(['png','jpg','jpeg','gif','svg','webp'].includes(ext)) return '🖼️';
      if(['html','htm','md','txt'].includes(ext)) return '🔗';
      if(['zip','7z','rar'].includes(ext)) return '🗂️';
      return '🔗';
    }
    function prettyTitleFromFilename(name){
      const noExt = name.replace(/\.[^.]+$/, '');
      return decodeURIComponent(noExt).replace(/[\-_]+/g,' ').replace(/\s+/g,' ').trim();
    }

    const elUnits = document.getElementById('units');
    const elToc = document.getElementById('tocList');
    const brandMeta = document.getElementById('brandMeta');

    // ------------- Data loaders (units) -------------
    async function fetchGithubUnits(cfg){
      const base = `https://api.github.com/repos/${cfg.user}/${cfg.repo}/contents/${cfg.unitsDir}?ref=${cfg.branch}`;
      const listResp = await fetch(base);
      if(!listResp.ok) throw new Error('Failed to list units directory: ' + listResp.status);
      const list = await listResp.json();
      const jsonFiles = list.filter(item => item.type === 'file' && /\.json$/i.test(item.name));
      const units = [];
      for(const f of jsonFiles){
        const rawUrl = `https://raw.githubusercontent.com/${cfg.user}/${cfg.repo}/${cfg.branch}/${cfg.unitsDir}/${encodeURIComponent(f.name)}`;
        const r = await fetch(rawUrl);
        if(!r.ok){ console.warn('Failed to fetch', f.name); continue; }
        units.push(await r.json());
      }
      return units;
    }

    async function fetchLocalUnits(cfg){
      const units = [];
      if(cfg.useManifest){
        try{
          const m = await fetch(cfg.manifest, { cache: 'no-store' });
          if(m.ok){
            const list = await m.json();
            const files = Array.isArray(list) ? list : (Array.isArray(list.files) ? list.files : []);
            for(const name of files){
              const r = await fetch(`${cfg.unitsDir}/${name}`, { cache: 'no-store' });
              if(r.ok) units.push(await r.json());
            }
            return units;
          }
        }catch(err){ console.warn('Manifest load error, falling back to probe.', err); }
      }
      const { startAt=1, maxUnits=24, probePattern='unit-${n}.json' } = cfg;
      for(let n=startAt; n<=maxUnits; n++){
        const filename = probePattern.replace('${n}', n);
        const url = `${cfg.unitsDir}/${filename}`;
        try{
          const r = await fetch(url, { cache: 'no-store' });
          if(r.ok){ units.push(await r.json()); }
        }catch{ /* ignore */ }
      }
      return units;
    }

    // ------------- Attachment discovery -------------
    async function listGithubFilesForUnit(unitId){
      const { user, repo, branch } = CONFIG.github;
      const baseDir = CONFIG.docs.baseDirGithub.replace(/\/$/,'');
      const url = `https://api.github.com/repos/${user}/${repo}/contents/${baseDir}/${unitId}?ref=${branch}`;
      const resp = await fetch(url);
      if(!resp.ok) return [];
      const list = await resp.json();
      return list.filter(x => x.type === 'file').map(x => x.name);
    }

    async function listLocalFilesForUnit(unitId){
      // Requires a simple manifest at attachments/index.json => { "unit-2": ["file.docx", ...], ... }
      try{
        const m = await fetch(CONFIG.docs.localManifest, { cache: 'no-store' });
        if(!m.ok) return [];
        const map = await m.json();
        return Array.isArray(map?.[unitId]) ? map[unitId] : [];
      }catch{ return []; }
    }

    async function attachDiscoveredDocs(units, mode){
      const isGithub = mode === 'github';
      const tasks = units.map(async u => {
        if(!u || !u.id) return u;
        let files = [];
        if(isGithub){
          files = await listGithubFilesForUnit(u.id);
        } else {
          files = await listLocalFilesForUnit(u.id);
        }
        const autoDocs = files.map(name => {
          const title = prettyTitleFromFilename(name);
          const icon = fileIconByExt(name);
          let href;
          if(isGithub){
            const { user, repo, branch } = CONFIG.github;
            const baseDir = CONFIG.docs.baseDirGithub.replace(/\/$/,'');
            href = `https://raw.githubusercontent.com/${user}/${repo}/${branch}/${baseDir}/${u.id}/${encodeURIComponent(name)}`;
          } else {
            const baseDir = CONFIG.docs.baseDirLocal.replace(/\/$/,'');
            href = `${baseDir}/${u.id}/${encodeURIComponent(name)}`;
          }
          return { title, href, type: name.split('.').pop(), desc: '' };
        });
        // Merge with any existing declared documents (if any)
        const declared = Array.isArray(u.documents) ? u.documents : [];
        u.documents = [...declared, ...autoDocs];
        return u;
      });
      return Promise.all(tasks);
    }

    // --------------- Renderer ---------------
    function render(units){
      brandMeta.innerHTML = `${CONFIG.student} · Module: <em>${CONFIG.module}</em> · Academic Year: ${CONFIG.academicYear}`;
      const sorted = (units||[]).slice().sort((a,b)=> (a.number||0)-(b.number||0) || String(a.id).localeCompare(String(b.id)));

      // TOC
      elToc.innerHTML = '';
      sorted.filter(u=>u && u.title).forEach(u=>{
        const li = document.createElement('li');
        li.innerHTML = `<a href="#${u.id}"><span class="toc-unit">${u.number ?? ''}</span><span>${u.title}</span></a>`;
        elToc.appendChild(li);
      });

      // Units
      elUnits.innerHTML = '';
      sorted.forEach(u=>{
        if(!u || !u.id) return;
        const docs = Array.isArray(u.documents)?u.documents:[];
        const section = document.createElement('section');
        section.className = 'unit';
        section.id = u.id;
        section.setAttribute('aria-labelledby', `${u.id}-title`);
        section.innerHTML = `
          <header>
            <h2 id="${u.id}-title">Unit ${u.number ?? ''}: ${u.title}<a class="hash" href="#${u.id}" aria-label="Anchor to ${u.title}">#</a></h2>
            <div class="summary">
              ${u.activities?`<p><span class="label">Activities:</span><span>${u.activities}</span></p>`:''}
              ${u.skills?`<p><span class="label">Skills:</span><span>${u.skills}</span></p>`:''}
              ${u.impact?`<p><span class="label">Integration & Impact:</span><span>${u.impact}</span></p>`:''}
            </div>
            ${docs.length?`<div class="docs">${docs.map(d=>`
              <div class="doc">
                <a href="${resolveHref(d.href)}" target="_blank" rel="noopener">${fileIconByExt(d.href)} ${d.title||d.href}</a>
                ${d.desc?`<small>${d.desc}</small>`:''}
              </div>`).join('')}</div>`:''}
            ${Array.isArray(u.references)&&u.references.length?`<ol class="refs">${u.references.map(r=>`<li>${r}</li>`).join('')}</ol>`:''}
          </header>`;
        elUnits.appendChild(section);
      });
    }

    // ----------------- Boot -----------------
    (async function boot(){
      let units = [];
      const isLocalHost = ['localhost','127.0.0.1','::1'].includes(location.hostname) || location.protocol === 'file:';
      const pageMode = CONFIG.mode === 'auto' ? (isLocalHost ? 'local' : 'github') : CONFIG.mode;
      try{
        units = (pageMode === 'local') ? await fetchLocalUnits(CONFIG.local) : await fetchGithubUnits(CONFIG.github);
      }catch(e){
        console.error(e);
        const err = document.createElement('p');
        err.textContent = `Failed to load units in ${pageMode} mode. Check CONFIG and file paths.`;
        document.getElementById('content').appendChild(err);
      }

      // Attach auto‑discovered documents
      const docsMode = 'local'; // Always use manifest on both local and GitHub
      try{
        units = await attachDiscoveredDocs(units, docsMode);
      }catch(e){ console.warn('Auto‑docs failed:', e); }

      render(units);
    })();
  </script>
</body>
</html>
